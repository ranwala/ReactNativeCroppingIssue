//
//  ScanbotStorageUtils.m
//  Scanbot SDK ReactNative Module
//
//  Copyright (c) 2017 doo GmbH. All rights reserved.
//

#import "InternalScanbotStorageUtils.h"
#import "SharedConfiguration.h"
#import "React/RCTLog.h"
#import "NSString+FileUtils.h"

@implementation InternalScanbotStorageUtils

+ (NSURL *)pluginStorageDirectoryURL {
    return [NSURL fileURLWithPath: [InternalScanbotStorageUtils pluginStorageDirectoryPath] isDirectory:YES];
}

+ (NSString *)pluginStorageDirectoryPath {
    NSString* pluginStorageDirectoryPath;
    
    NSString* customStorageBaseDirectoryUrl = [SharedConfiguration defaultConfiguration].sdkConfiguration.storageBaseDirectory;
    if (customStorageBaseDirectoryUrl) {
        NSString* customStorageBaseDirectoryPath = [NSURL URLWithString: customStorageBaseDirectoryUrl].path;
        pluginStorageDirectoryPath = [NSString stringWithFormat:@"%@/%@", customStorageBaseDirectoryPath, pluginStorageSubDirectory];
    } else {
        NSString* defaultStorageBaseDirectory = [InternalScanbotStorageUtils scanbotSDKApplicationSupportFolder].path;
        pluginStorageDirectoryPath = [NSString stringWithFormat:@"%@/%@", defaultStorageBaseDirectory, pluginStorageSubDirectory];
    }
    
    [InternalScanbotStorageUtils recreateFolderIfNeeded:pluginStorageDirectoryPath];
    return pluginStorageDirectoryPath;
}

+ (BOOL)pluginStorageDirectoryExists {
    return [[NSFileManager defaultManager] fileExistsAtPath:[InternalScanbotStorageUtils pluginStorageDirectoryPath]];
}

+ (NSURL *)applicationSupportFolderURL {
    NSArray *paths = NSSearchPathForDirectoriesInDomains(NSApplicationSupportDirectory, NSUserDomainMask, YES);
    return [NSURL fileURLWithPath:(NSString *)paths.firstObject isDirectory:YES];
}

+ (NSURL *)scanbotSDKApplicationSupportFolder {
    NSURL *url = [InternalScanbotStorageUtils applicationSupportFolderURL];
    return [url URLByAppendingPathComponent:@"io.scanbot.sdk" isDirectory:YES];
}

+ (void)recreateFolderIfNeeded:(NSString *)folderPath {
    if (![[NSFileManager defaultManager] fileExistsAtPath:folderPath]) {
        [[NSFileManager defaultManager] createDirectoryAtPath:folderPath
                                  withIntermediateDirectories:YES
                                                   attributes:nil
                                                        error:nil];
    }
}

+ (NSString *)generateFileName:(NSString *)extension {
    NSUUID *UUID = [NSUUID UUID];
    NSString *stringUUID = [[UUID UUIDString] lowercaseString];
    return [NSString stringWithFormat:@"%@.%@", stringUUID, extension];
}

+ (NSString *)generatePluginStorageFilePath:(NSString *)extension {
    NSString *pluginStoragePath = [InternalScanbotStorageUtils pluginStorageDirectoryPath];
    return [NSString stringWithFormat:@"%@/%@", pluginStoragePath, [InternalScanbotStorageUtils generateFileName:extension]];
}

+ (UIImage *)loadImage:(NSString *)imageFilePath {
    if ([InternalScanbotStorageUtils imageFileExists:imageFilePath]) {
        UIImage *image = [UIImage imageWithData:[NSData dataWithContentsOfFile:imageFilePath]];
        if (!image) {
            image = [UIImage imageWithData:[NSData dataWithContentsOfURL:[NSURL URLWithString:imageFilePath]]];
        }
        return image;
    } else {
        RCTLogError(@"Image loading failed. File %@ does not exist.", imageFilePath);
        return nil;
    }
}

+ (BOOL)saveImage:(NSString *)imageFilePath image:(UIImage *)image quality:(CGFloat)quality {
    NSData *imageData = UIImageJPEGRepresentation(image, quality);
    return [imageData writeToFile:imageFilePath atomically:YES];
}

+ (NSError *)removeAllFilesFromPluginStorageDirectory {
    NSString *pluginStoragePath = [InternalScanbotStorageUtils pluginStorageDirectoryPath];
    NSFileManager *fileManager = [NSFileManager new];
    NSDirectoryEnumerator *enumerator = [fileManager enumeratorAtPath:pluginStoragePath];
    NSError *err = nil;
    BOOL result;
    
    NSString *fileName;
    while (fileName = [enumerator nextObject]) {
        result = [fileManager removeItemAtPath:[pluginStoragePath stringByAppendingPathComponent:fileName] error:&err];
        if (!result && err) {
            RCTLogError(@"Cleanup encountered an error: %@", err);
            break;
        }
    }
    return err;
}

+ (BOOL)imageFileExists:(NSString *)imageFileUri {
    NSString* path = [NSURL URLWithString:[imageFileUri stringBySanitizingWhiteSpaces]].path;
    return [[NSFileManager defaultManager] fileExistsAtPath: path];
}

@end
