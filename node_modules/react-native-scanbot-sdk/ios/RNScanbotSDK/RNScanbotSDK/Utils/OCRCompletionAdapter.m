//
//  Scanbot SDK ReactNative Module
//
//  Copyright (c) 2019 doo GmbH. All rights reserved.
//

#import "OCRCompletionAdapter.h"

#import "InternalScanbotStorageUtils.h"
#import "SBSDKOCRResult+JSON.h"

@implementation OCRCompletionAdapter

- (instancetype)initWithOutputFormat:(NSString *)outputFormat {
    if (self = [super init]) {
        
        if ([outputFormat isEqualToString:@"PDF_FILE"] || [outputFormat isEqualToString:@"FULL_OCR_RESULT"]) {
            self->_outputPDFURL = [NSURL fileURLWithPath:[InternalScanbotStorageUtils generatePluginStorageFilePath:@"pdf"]];
        }
        
        self->_outputFormat = outputFormat;
        return self;
    }
    
    return nil;
}

+ (instancetype)adapterWithOutputFormat:(NSString *)outputFormat {
    return [[self alloc] initWithOutputFormat:outputFormat];
}

- (SBSDKCompletionHandler)adaptBlock:(OCRCompletionHandler)completion {
    return ^(BOOL finished, NSError *error, NSDictionary *resultInfo) {
        
        if (!finished || error) {
            completion(nil, error);
            return;
        }
        
        SBSDKOCRResult *result = resultInfo[SBSDKResultInfoOCRResultsKey];
        NSError *resultError;
        NSDictionary *resultDict = [self resultDictWith:result error:&resultError];
        
        if (resultError) {
            completion(nil, resultError);
            return;
        }
        
        completion(resultDict, nil);
    };
}

- (nullable NSDictionary *)resultDictWith:(SBSDKOCRResult *)result error:(NSError **)error {
    
    if ([self.outputFormat isEqualToString:@"PLAIN_TEXT"]) {
        return @{@"plainText": result.recognizedText};
    }
    
    if ([self.outputFormat isEqualToString:@"PDF_FILE"]) {
        return @{@"pdfFileUri": self.outputPDFURL.absoluteString};
    }
    
    if (*error) {
        return nil;
    }
    
    if ([self.outputFormat isEqualToString:@"RESULT_JSON"]) {
        return @{@"jsonData": [result dictionaryRepresentation]};
    }
    
    if ([self.outputFormat isEqualToString:@"FULL_OCR_RESULT"]) {
        return @{@"jsonData": [result dictionaryRepresentation],
                 @"pdfFileUri": self.outputPDFURL.absoluteString};
    }
    
    return nil;
}

@end
